<!DOCTYPE html>
<html>

<head>
    <title>Family Truths - HOST</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>

<body>

    <div id="setup-panel" style="display:block;">
        <h1 class="animate__animated animate__fadeInDown">Family Truths Setup</h1>
        <div class="setup-form">
            <input type="text" id="q-text" placeholder="Question (e.g. Dad's first car?)">
            <input type="text" id="q-answer" placeholder="The Truth (e.g. Honda Civic)">
            <input type="text" id="q-lie1" placeholder="House Lie #1 (Optional)">
            <input type="text" id="q-lie2" placeholder="House Lie #2 (Optional)">
            <button onclick="addQuestion()">Add to Deck</button>
            <button onclick="startGame()" style="background: #4caf50; margin-top: 20px;">START GAME</button>
        </div>
        <div id="deck-status" style="margin-top: 20px; color: #888;">Questions in Deck: 0</div>

        <div style="margin-top: 20px;">
            <button onclick="toggleManageQuestions()" style="background: #555; font-size: 1em; padding: 10px;">Manage
                Questions</button>
        </div>

        <!-- Manage Modal (Simple Overlay) -->
        <div id="manage-overlay"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; overflow-y:auto; padding:50px;">
            <h2>Manage Questions <button onclick="toggleManageQuestions()"
                    style="float:right; font-size:0.8em; background:#d32f2f;">CLOSE</button></h2>
            <div id="questions-list"
                style="display:flex; flex-direction:column; gap:10px; max-width:800px; margin:0 auto;"></div>
        </div>
    </div>

    <div id="host-app" style="display:none;">
        <div id="game-info-bar" style="position:absolute; top:10px; left:10px; font-size:1.2em; color:#888;"></div>


        <!-- LOBBY -->
        <div id="view-lobby" style="display:none;">
            <h1 class="huge-text animate__animated animate__bounceIn">Code: FAMILY</h1>
            <h2 class="animate__animated animate__fadeIn">Join at: <span id="ip-address"></span>/player</h2>
            <ul id="player-list-lobby" class="player-list"></ul>
            <button onclick="triggerStart()"
                style="font-size: 2em; padding: 10px 30px; margin-top: 30px; cursor: pointer;">EVERYONE IS IN</button>
        </div>

        <!-- BLUFF INPUT -->
        <div id="view-bluff" style="display:none;">
            <h2 class="big-text animate__animated animate__fadeInDown" id="bluff-question"></h2>
            <div class="timer-bar">
                <div id="bluff-timer" class="timer-fill"></div>
            </div>
            <ul id="player-list-bluff" class="player-list" style="margin-top: 50px;"></ul>
        </div>

        <!-- VOTING -->
        <div id="view-voting" style="display:none;">
            <h2 class="big-text animate__animated animate__fadeIn" id="vote-question"></h2>
            <div class="timer-bar">
                <div id="vote-timer" class="timer-fill"></div>
            </div>
            <div id="options-grid" class="options-grid"></div>
        </div>

        <!-- REVEAL -->
        <div id="view-reveal" style="display:none;">
            <h2 class="big-text" id="reveal-question"></h2>
            <div id="reveal-grid" class="options-grid"></div>
            <h1 id="reveal-status" class="huge-text animate__animated animate__zoomIn" style="margin-top: 20px;"></h1>
        </div>

        <!-- SCOREBOARD -->
        <div id="view-scoreboard" style="display:none;">
            <h1 class="huge-text">Leaderboard</h1>
            <ul id="leaderboard-list" class="player-list" style="flex-direction: column;"></ul>
            <button onclick="nextRound()" style="font-size: 2em; padding: 20px; margin-top: 30px;">NEXT ROUND</button>
        </div>

    </div>

    <script>
        var socket = io();
        var questionsParams = new URLSearchParams(window.location.search);
        var deckSize = 0;

        // Sounds
        //var sfxJoin = new Howl({ src: ['/static/join.mp3'] }); // Placeholder
        //var sfxTimer = new Howl({ src: ['/static/timer.mp3'] }); // Placeholder

        document.getElementById('ip-address').innerText = window.location.hostname + ":5000";

        // --- SETUP FUNCTIONS ---
        function addQuestion() {
            var q = document.getElementById('q-text').value;
            var a = document.getElementById('q-answer').value;
            var l1 = document.getElementById('q-lie1').value;
            var l2 = document.getElementById('q-lie2').value;

            if (q && a) {
                console.log("Sending add_question event:", { question: q, answer: a });
                socket.emit('add_question', {
                    question: q,
                    answer: a,
                    house_lies: [l1, l2]
                });
                // Clear inputs
                document.getElementById('q-text').value = '';
                document.getElementById('q-answer').value = '';
                document.getElementById('q-lie1').value = '';
                document.getElementById('q-lie2').value = '';
            } else {
                alert("Question and Answer are required!");
            }
        }

        function startGame() {
            // We can start if we have questions.
            // Server check should be the source of truth, but local check is fine for UI feedback.
            if (deckSize > 0) {
                socket.emit('start_game');
            } else {
                alert("Add at least one question!");
            }
        }


        function triggerStart() {
            socket.emit('start_game');
        }

        function nextRound() {
            socket.emit('next_round');
        }

        // --- SOCKET EVENTS ---

        socket.on('question_added', function (data) {
            // We rely on deck_status for count update, but this event might still be useful for animation/logs
            console.log("Question added", data);
        });

        socket.on('deck_status', function (data) {
            deckSize = data.count;
            document.getElementById('deck-status').innerText = "Questions in Deck: " + deckSize;
        });

        // Auto-login as host on connect to get state
        socket.on('connect', function () {
            console.log("Connected as Host");
            socket.emit('host_login');
        });


        socket.on('state_update', function (data) {
            console.log("State Update:", data);
            renderState(data);
        });

        socket.on('timer_update', function (data) {
            var pars = {
                'BLUFF_INPUT': { id: 'bluff-timer', max: 60 },
                'VOTING': { id: 'vote-timer', max: 30 }
            };
            // Simple heuristic to find active timer
            // ideally state update sends max time, but hardcoded for now
            var current = document.querySelector('.timer-fill:not([style*="width: 0%"])');
            // actually easier to just set width for active view
            var activeTimer = null;
            var maxTime = 60;

            if (document.getElementById('view-bluff').style.display === 'block') {
                activeTimer = document.getElementById('bluff-timer');
                maxTime = 60;
            } else if (document.getElementById('view-voting').style.display === 'block') {
                activeTimer = document.getElementById('vote-timer');
                maxTime = 30;
            }

            if (activeTimer) {
                var pct = (data.time_left / maxTime) * 100;
                activeTimer.style.width = pct + "%";
                if (data.time_left <= 10) {
                    activeTimer.style.backgroundColor = 'red';
                } else {
                    activeTimer.style.backgroundColor = '#ff5722';
                }
            }
        });

        function renderState(data) {
            // Hide all views first
            ['view-lobby', 'view-bluff', 'view-voting', 'view-reveal', 'view-scoreboard'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            if (data.state === 'LOBBY') {
                // If we are in LOBBY, we might still be in setup mode if no one pressed START yet?
                // Actually start_game switches to BLUFF_INPUT.
                // But wait, if we are just setting up questions, we are in LOBBY state on server (default).
                // But we want to show Setup Panel UNTIL we decide to open the lobby?
                // The original code had "Setup Panel" -> "Start Game" (which opened Lobby view?) -> "Everyone is in" (Start Game event).

                // Let's refine:
                // Setup Panel is "Pre-Lobby".
                // Once we click "START GAME" in setup, we technically just show the lobby view?
                // NO, 'startGame' function in original code just hid setup panel and showed host-app.
                // And emitted 'host_login'.

                // So:
                // If deckSize > 0, we can show Lobby.
                // If we receive LOBBY state, we should probably show the Lobby view IF we are past setup?
                // Let's use the 'host-app' visibility as a guide.

                // Better approach:
                // If we receive data.state, it means we are connected.
                // If state is LOBBY and we have questions, we can show LOBBY view.
                // If deckSize is 0, we MUST show setup panel.

                if (deckSize > 0) {
                    document.getElementById('setup-panel').style.display = 'none';
                    document.getElementById('host-app').style.display = 'flex';
                    document.getElementById('view-lobby').style.display = 'block';
                } else {
                    // Stay in setup
                    document.getElementById('setup-panel').style.display = 'block';
                    document.getElementById('host-app').style.display = 'none';
                }

                var list = document.getElementById('player-list-lobby');
                list.innerHTML = '';
                data.players.forEach(p => {
                    var item = document.createElement('li');
                    item.className = 'player-card animate__animated animate__bounceIn';
                    item.innerHTML = `<div><span style="font-size:2em; display:block;">${p.avatar || 'ðŸ‘¤'}</span>${p.name}</div>`;
                    list.appendChild(item);
                });


            } else if (data.state === 'BLUFF_INPUT') {
                document.getElementById('setup-panel').style.display = 'none';
                document.getElementById('host-app').style.display = 'flex';
                document.getElementById('view-bluff').style.display = 'block';
                document.getElementById('bluff-question').innerText = data.question;
                var list = document.getElementById('player-list-bluff');
                list.innerHTML = '';
                data.players.forEach(p => {
                    var item = document.createElement('li');
                    // Check if submitted
                    var isDone = data.submitted_players && data.submitted_players.includes(p.name);
                    item.className = 'player-card ' + (isDone ? 'done animate__animated animate__pulse' : 'typing');
                    item.innerText = p.name + (isDone ? ' (Reviewing Lie)' : ' (Writing Lie...)');
                    list.appendChild(item);
                });

            } else if (data.state === 'VOTING') {
                document.getElementById('setup-panel').style.display = 'none';
                document.getElementById('host-app').style.display = 'flex';
                document.getElementById('view-voting').style.display = 'block';
                document.getElementById('vote-question').innerText = data.question;
                var grid = document.getElementById('options-grid');
                grid.innerHTML = '';
                data.options.forEach(opt => {
                    var card = document.createElement('div');
                    card.className = 'option-card animate__animated animate__fadeInUp';
                    card.innerText = opt.text;
                    grid.appendChild(card);
                });

            } else if (data.state === 'REVEAL') {
                document.getElementById('setup-panel').style.display = 'none';
                document.getElementById('host-app').style.display = 'flex';
                document.getElementById('view-reveal').style.display = 'block';
                document.getElementById('reveal-question').innerText = data.question;
                // Only run reveal sequence if this is the first time receiving this state?
                // Actually, we should check if we are already revealing to avoid restart on reconnect.
                // But strict "drama" requires client-side sequencing.
                // For robustness, we'll just clear and run sequence.
                runRevealSequence(data.reveal_sequence);

            } else if (data.state === 'SCOREBOARD') {
                document.getElementById('setup-panel').style.display = 'none';
                document.getElementById('host-app').style.display = 'flex';
                document.getElementById('view-scoreboard').style.display = 'block';
                var list = document.getElementById('leaderboard-list');
                list.innerHTML = '';
                data.leaderboard.forEach(p => {
                    var item = document.createElement('li');
                    item.className = 'player-card animate__animated animate__fadeInLeft';
                    item.innerText = p.name + ": " + p.score + " pts";
                    list.appendChild(item);
                });
            }

            // Update Info Bar
            var info = document.getElementById('game-info-bar');
            if (data.round_info) {
                info.innerText = `Question ${data.round_info.current} / ${data.round_info.total}`;
            } else {
                info.innerText = "";
            }
        }





        // --- MANAGE QUESTIONS ---
        function toggleManageQuestions() {
            var el = document.getElementById('manage-overlay');
            el.style.display = (el.style.display === 'none') ? 'block' : 'none';
        }

        socket.on('question_list_update', function (data) {
            renderQuestionList(data.questions);
        });

        function renderQuestionList(questions) {
            var list = document.getElementById('questions-list');
            list.innerHTML = '';
            questions.forEach(q => {
                var item = document.createElement('div');
                item.className = 'setup-form';
                item.style.background = '#333';
                item.style.padding = '15px';
                item.style.borderRadius = '5px';
                item.innerHTML = `
                    <div style="display:flex; gap:10px;">
                        <input type="text" value="${q.text}" id="edit-q-${q.id}" style="flex:2;">
                        <input type="text" value="${q.answer}" id="edit-a-${q.id}" style="flex:1;">
                    </div>
                    <div style="margin-top:10px; text-align:right;">
                         <button onclick="saveQuestion('${q.id}')" style="background:#4caf50; font-size:0.8em; padding:5px 10px;">SAVE</button>
                         <button onclick="deleteQuestion('${q.id}')" style="background:#f44336; font-size:0.8em; padding:5px 10px;">DELETE</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function saveQuestion(id) {
            var q = document.getElementById('edit-q-' + id).value;
            var a = document.getElementById('edit-a-' + id).value;
            socket.emit('edit_question', { id: id, question: q, answer: a });
        }

        function deleteQuestion(id) {
            if (confirm("Delete this question?")) {
                socket.emit('delete_question', { id: id });
            }
        }

        function runRevealSequence(events) {
            var grid = document.getElementById('reveal-grid');
            grid.innerHTML = '';
            var status = document.getElementById('reveal-status');
            status.innerText = "";

            // Helper to add card
            function addCard(text) {
                var card = document.createElement('div');
                card.className = 'option-card';
                card.innerText = text;
                card.id = 'card-' + text; // simple ID
                grid.appendChild(card);
                return card;
            }

            // Ideally we populate the grid with all options first, hidden or neutral?
            // Let's just standard show them all neutral first, then animate.
            // Actually, let's just show them one by one as they are revealed for maximum drama.

            var delay = 0;
            events.forEach(function (ev) {
                setTimeout(function () {
                    var card = addCard(ev.text);
                    card.classList.add('animate__animated', 'animate__flipInX');

                    // Show author
                    if (ev.type === 'LIE') {
                        card.classList.add('reveal-lie');
                        var tag = document.createElement('span');
                        tag.className = 'author-tag';
                        tag.innerText = "By: " + ev.author;
                        card.appendChild(tag);

                        if (ev.voters.length > 0) {
                            status.innerText = ev.voters.join(', ') + " fell for it!";
                        } else {
                            status.innerText = "No one fell for this lie.";
                        }
                    } else if (ev.type === 'TRUTH') {
                        card.classList.add('reveal-truth');
                        var tag = document.createElement('span');
                        tag.className = 'author-tag';
                        tag.innerText = "THE TRUTH";
                        card.appendChild(tag);

                        status.innerText = ev.voters.length > 0 ? ev.voters.join(', ') + " got it right!" : "No one got it right!";
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                }, delay);
                delay += 4000;
            });
        }

    </script>
</body>

</html>